/*! 4159 2013-9-17 14:8:14 */
define(["lib/jquery/1_9","lib/jh","kit/loadElm","lib/jquery/serializeForJson","pjt/content_ex/transport/all","comp/tagInput","pjt/site/common/dailog"],function(e,t,n,i,o,a,r){var s=function(){var i={},s=r.panel.call("extend"),l=function(e){return e.key?(i.spec=e,i.buildDailog(),n(s.eDailog,i),i.oTagInput=a(i.node.tagInput),i.bindEvent(),i.loadData(),o.getUserTags({data:{bdstoken:__CONF__.bdstoken},ok:function(e){i.bindTags({aTagList:e.data.records})}}),void 0):(r.alert("请先选择要编辑的收藏"),void 0)};return i.loadData=function(){o.getUnitsInfo({data:{bdstoken:__CONF__.bdstoken,param:JSON.stringify({keylist:[i.spec.key]})},ok:function(e){e.data.unitList.records.length?s.bindData(e.data.unitList.records[0]):(r.alert("收藏不存在"),s.destroy())}})},s.bindData=function(e){i.node.tagInput.value=e.tags.join(", "),i.node.noteInput.value=e.note?e.note:""},i.buildDailog=function(){s._init({title:"编辑收藏",layoutClass:"edit-unit-panel",tipsHtml:'<form method="post" action="#" class="__editTagForm"><span class="noteLabel itemLabel">描述: </span><span class=""><textarea class="__noteInput text-input" maxlength="120" rows="3" cols="46"></textarea></span><span class="tagsLabel itemLabel">标签: </span><span class=""><input type="text" class="__tagInput text-input" /></span><p class="my-tag-tips __myTagTips" style="visibility:hidden;"><span class="title">我的标签: </span><span class="__tagList"></span></p></form><p class="edit-tag-btns"><a href="#" class="__saveTagBtn save-tag-btn sc-btn" type="submit"><span>保存</span></a><a href="#" class="__cancelBtn cancel-btn sc-btn" type="submit"><span>取消</span></a></p>'})},s.toSubmit=function(){s.checkForm()&&i.goSave()},s.checkForm=function(){var e=!0;return e=s.checkTags()&&e},s.checkTags=function(){return i.oTagInput.checkTags(function(e){e.error&&r.alert(e.error.msg)})},i.bindEvent=function(){e(s.eDailog).on("click",".__saveTagBtn",function(e){e.preventDefault(),s.toSubmit()}).on("click",".__cancelBtn",function(e){e.preventDefault(),s.hide(),s=null}).on("click","._tagBtn",function(t){t.preventDefault(),i.oTagInput.addTagToInput(e(this).find("._tagBtnText")[0].firstChild.data)}).on("submit",".__editTagForm",function(e){e.preventDefault(),s.toSubmit()})},i.renderTagList=function(e){var n="";t.forEach(e,function(e){n+='<a href="#" class="tag-btn _tagBtn"><span><span class="_tagBtnText">'+e+"</span></span></a> "}),i.node.tagList.innerHTML=n},i.bindTags=function(t){var n=[];t.aTagList=t.aTagList.sort(function(e,t){return e.num>t.num?-1:1});var o,a;for(o=0,a=t.aTagList.length;a>o;++o)n.push(t.aTagList[o].tag);i.renderTagList(n),n.length&&e(i.node.myTagTips).css("visibility","visible")},i.goSave=function(){if(!i.goSave.bMarching){i.goSave.bMarching=!0;var t=e("span",i.node.saveTagBtn);t.html(t.html()+"中...");var n={records:[{_key:i.spec.key,tags:i.oTagInput.getTagArray(),note:i.node.noteInput.value}]};o.updateUnit({data:{param:JSON.stringify(n),bdstoken:__CONF__.bdstoken},ok:function(e){i.spec.ok(e.data),s.destroy()}})}},l.apply(s,arguments),s};return s});